<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="אפליקציית רשימת קניות חכמה עם קטגוריזציה אוטומטית בעברית">
    <meta name="keywords" content="קניות, רשימה, עברית, אפליקציה, קטגוריות">
    <meta name="author" content="רשימת קניות חכמה">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="קניות">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon-152.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icon-144.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icon-120.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/icon-114.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/icon-76.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icon-72.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icon-60.png">
    <link rel="apple-touch-icon" sizes="57x57" href="/icon-57.png">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Splash Screen for iOS -->
    <link rel="apple-touch-startup-image" href="/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    
    <title>רשימת קניות חכמה</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Custom styles for better RTL support and PWA */
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            direction: rtl;
            overflow-x: hidden;
        }
        
        /* PWA specific styles */
        @media (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
            }
        }
        
        /* Loading animation */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hide scrollbar but keep functionality */
        body::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
        
        /* Prevent zoom on input focus (iOS) */
        input, textarea, select {
            font-size: 16px !important;
        }
        
        /* Better touch targets */
        button, input, textarea {
            min-height: 44px;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">
            <div>
                <div class="loading-spinner"></div>
                <p style="color: white; margin-top: 20px; text-align: center;">טוען אפליקציה...</p>
            </div>
        </div>
    </div>

    <!-- App Script -->
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Plus, Share2, Copy, Trash2, Edit3, Check, X } = lucide;

        const GroceryApp = () => {
            const [items, setItems] = useState([]);
            const [newItem, setNewItem] = useState('');
            const [bulkText, setBulkText] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [editingText, setEditingText] = useState('');
            const [showBulkInput, setShowBulkInput] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                // Handle PWA install prompt
                const handleBeforeInstallPrompt = (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                };

                // Handle online/offline status
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);

                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                
                // Register service worker for PWA functionality
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            console.log('Service Worker registered successfully:', registration);
                        })
                        .catch((error) => {
                            console.log('Service Worker registration failed:', error);
                        });
                }

                // Load saved data from localStorage
                const savedItems = localStorage.getItem('groceryItems');
                if (savedItems) {
                    try {
                        setItems(JSON.parse(savedItems));
                    } catch (error) {
                        console.error('Error loading saved items:', error);
                    }
                }

                return () => {
                    window.removeEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            // Save items to localStorage whenever items change
            useEffect(() => {
                localStorage.setItem('groceryItems', JSON.stringify(items));
            }, [items]);

            const handleInstallClick = async () => {
                if (!installPrompt) return;
                
                installPrompt.prompt();
                const { outcome } = await installPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    setInstallPrompt(null);
                }
            };

            // Hebrew grocery categories
            const categories = {
                'ירקות ופירות': ['עגבנייה', 'מלפפון', 'גזר', 'בצל', 'שום', 'פלפל', 'חסה', 'כרוב', 'תפוח', 'בננה', 'תפוז', 'לימון', 'אבוקדו', 'תותים', 'ענבים', 'פטריות', 'תרד', 'ברוקולי', 'קישוא', 'חציל', 'תפוח אדמה', 'בטטה'],
                'חלב וביצים': ['חלב', 'ביצים', 'גבינה', 'יוגורט', 'חמאה', 'שמנת', 'קוטג׳', 'לבנה', 'גבינת שמנת', 'מוצרלה', 'פרמזן', 'גבינה צהובה', 'גבינת עיזים'],
                'בשר ודגים': ['עוף', 'בקר', 'כבש', 'דג', 'סלמון', 'טונה', 'נקניקיות', 'נתחי עוף', 'כנפיים', 'שניצל', 'קבב', 'המבורגר', 'בשר טחון'],
                'דגנים ולחם': ['לחם', 'פיתה', 'בגט', 'אורז', 'פסטה', 'קמח', 'שיבולת שועל', 'קינואה', 'קורנפלקס', 'מצות', 'קרקרים', 'לחם מקמח מלא'],
                'שימורים': ['עגבניות מרוסקות', 'טונה', 'זיתים', 'חומוס', 'טחינה', 'ריבה', 'דבש', 'חרדל', 'קטשופ', 'מיונז', 'רוטב סויה', 'שמן זית', 'חומץ'],
                'מוצרי ניקיון': ['אבקת כביסה', 'מרכך כביסה', 'נוזל כלים', 'מגבונים', 'נייר טואלט', 'מגבות נייר', 'חומר ניקוי', 'דטרגנט', 'אמוניה'],
                'משקאות': ['מים', 'מיץ', 'קולה', 'בירה', 'יין', 'קפה', 'תה', 'חלב שקדים', 'משקה אנרגיה', 'סודה'],
                'קפואים': ['גלידה', 'ירקות קפואים', 'פיצה קפואה', 'דגים קפואים', 'שניצל קפוא', 'פירות יער קפואים'],
                'חטיפים וממתקים': ['שוקולד', 'במבה', 'ביסלי', 'עוגיות', 'גומי', 'ממתקים', 'צ׳יפס', 'פופקורן', 'אגוזים', 'תמרים'],
                'אחר': []
            };

            const categorizeItem = (itemName) => {
                const lowerItem = itemName.toLowerCase().trim();
                
                for (const [category, keywords] of Object.entries(categories)) {
                    if (category === 'אחר') continue;
                    
                    for (const keyword of keywords) {
                        if (lowerItem.includes(keyword.toLowerCase()) || keyword.toLowerCase().includes(lowerItem)) {
                            return category;
                        }
                    }
                }
                return 'אחר';
            };

            const addItem = (itemText) => {
                if (!itemText.trim()) return;
                
                const category = categorizeItem(itemText);
                const newItemObj = {
                    id: Date.now() + Math.random(),
                    text: itemText.trim(),
                    category,
                    completed: false
                };
                
                setItems(prev => [...prev, newItemObj]);
            };

            const handleAddSingle = () => {
                addItem(newItem);
                setNewItem('');
            };

            const handleBulkAdd = () => {
                const lines = bulkText.split('\n').filter(line => line.trim());
                lines.forEach(line => {
                    // Clean up common prefixes from messaging apps
                    const cleanLine = line.replace(/^[-•*]\s*/, '').replace(/^\d+\.\s*/, '').trim();
                    if (cleanLine) {
                        addItem(cleanLine);
                    }
                });
                setBulkText('');
                setShowBulkInput(false);
            };

            const deleteItem = (id) => {
                setItems(prev => prev.filter(item => item.id !== id));
            };

            const toggleCompleted = (id) => {
                setItems(prev => prev.map(item => 
                    item.id === id ? { ...item, completed: !item.completed } : item
                ));
            };

            const startEditing = (id, text) => {
                setEditingId(id);
                setEditingText(text);
            };

            const saveEdit = (id) => {
                if (!editingText.trim()) return;
                
                const newCategory = categorizeItem(editingText);
                setItems(prev => prev.map(item => 
                    item.id === id ? { ...item, text: editingText.trim(), category: newCategory } : item
                ));
                setEditingId(null);
                setEditingText('');
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditingText('');
            };

            const shareList = async () => {
                const listText = Object.entries(groupedItems)
                    .map(([category, items]) => `${category}:\n${items.map(item => `• ${item.text}`).join('\n')}`)
                    .join('\n\n');
                
                try {
                    if (navigator.share && navigator.canShare && navigator.canShare({ text: listText })) {
                        await navigator.share({
                            title: 'רשימת קניות',
                            text: listText
                        });
                    } else {
                        await navigator.clipboard.writeText(listText);
                        alert('הרשימה הועתקה ללוח - תוכל להדביק אותה בכל אפליקציה');
                    }
                } catch (error) {
                    // Fallback if clipboard API also fails
                    try {
                        await navigator.clipboard.writeText(listText);
                        alert('הרשימה הועתקה ללוח');
                    } catch (clipboardError) {
                        // Manual fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = listText;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('הרשימה הועתקה ללוח');
                    }
                }
            };

            const copyList = async () => {
                const listText = Object.entries(groupedItems)
                    .map(([category, items]) => `${category}:\n${items.map(item => `• ${item.text}`).join('\n')}`)
                    .join('\n\n');
                
                try {
                    await navigator.clipboard.writeText(listText);
                    alert('הרשימה הועתקה ללוח');
                } catch (error) {
                    // Manual fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = listText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('הרשימה הועתקה ללוח');
                }
            };

            // Group items by category
            const groupedItems = items.reduce((acc, item) => {
                if (!acc[item.category]) {
                    acc[item.category] = [];
                }
                acc[item.category].push(item);
                return acc;
            }, {});

            // Get category order (prioritize categories with items)
            const categoryOrder = Object.keys(categories).filter(cat => groupedItems[cat]?.length > 0);

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100" dir="rtl">
                    {/* Offline indicator */}
                    {!isOnline && (
                        <div className="bg-red-500 text-white text-center py-2 text-sm">
                            🔌 אין חיבור לאינטרנט - הנתונים נשמרים מקומית
                        </div>
                    )}
                    
                    <div className="container mx-auto px-4 py-8 max-w-4xl">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-8">
                            <div className="flex justify-between items-center mb-4">
                                <h1 className="text-3xl font-bold text-gray-800 text-center flex-1">רשימת קניות חכמה</h1>
                                {installPrompt && (
                                    <button
                                        onClick={handleInstallClick}
                                        className="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-colors text-sm whitespace-nowrap"
                                    >
                                        התקן אפליקציה
                                    </button>
                                )}
                            </div>
                            
                            {/* Add Item Section */}
                            <div className="space-y-4">
                                <div className="flex gap-3">
                                    <input
                                        type="text"
                                        value={newItem}
                                        onChange={(e) => setNewItem(e.target.value)}
                                        placeholder="הוסף פריט חדש..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        onKeyPress={(e) => e.key === 'Enter' && handleAddSingle()}
                                    />
                                    <button
                                        onClick={handleAddSingle}
                                        className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2"
                                    >
                                        <Plus size={20} />
                                        הוסף
                                    </button>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowBulkInput(!showBulkInput)}
                                        className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm"
                                    >
                                        הוספה מרובה
                                    </button>
                                    
                                    {items.length > 0 && (
                                        <>
                                            <button
                                                onClick={shareList}
                                                className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2"
                                            >
                                                <Share2 size={16} />
                                                שתף
                                            </button>
                                            <button
                                                onClick={copyList}
                                                className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-colors text-sm flex items-center gap-2"
                                            >
                                                <Copy size={16} />
                                                העתק
                                            </button>
                                        </>
                                    )}
                                </div>

                                {showBulkInput && (
                                    <div className="border-t pt-4">
                                        <textarea
                                            value={bulkText}
                                            onChange={(e) => setBulkText(e.target.value)}
                                            placeholder="הדבק כאן רשימת קניות מוואטסאפ או מקום אחר... (פריט אחד בכל שורה)"
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent h-32 resize-none"
                                        />
                                        <div className="flex gap-3 mt-3">
                                            <button
                                                onClick={handleBulkAdd}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors"
                                            >
                                                הוסף הכל
                                            </button>
                                            <button
                                                onClick={() => setShowBulkInput(false)}
                                                className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                                            >
                                                ביטול
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Items List */}
                        {items.length > 0 && (
                            <div className="space-y-6">
                                {categoryOrder.map(category => (
                                    <div key={category} className="bg-white rounded-2xl shadow-lg overflow-hidden">
                                        <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4">
                                            <h2 className="text-xl font-semibold flex items-center justify-between">
                                                {category}
                                                <span className="text-sm bg-white/20 px-3 py-1 rounded-full">
                                                    {groupedItems[category].length}
                                                </span>
                                            </h2>
                                        </div>
                                        <div className="p-4">
                                            <div className="grid gap-3">
                                                {groupedItems[category].map(item => (
                                                    <div
                                                        key={item.id}
                                                        className={`flex items-center justify-between p-3 rounded-lg border transition-all ${
                                                            item.completed 
                                                                ? 'bg-green-50 border-green-200 opacity-60' 
                                                                : 'bg-gray-50 border-gray-200 hover:bg-gray-100'
                                                        }`}
                                                    >
                                                        <div className="flex items-center gap-3 flex-1">
                                                            <input
                                                                type="checkbox"
                                                                checked={item.completed}
                                                                onChange={() => toggleCompleted(item.id)}
                                                                className="w-5 h-5 text-green-500 rounded focus:ring-green-500"
                                                            />
                                                            
                                                            {editingId === item.id ? (
                                                                <input
                                                                    type="text"
                                                                    value={editingText}
                                                                    onChange={(e) => setEditingText(e.target.value)}
                                                                    className="flex-1 px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                                                    onKeyPress={(e) => {
                                                                        if (e.key === 'Enter') saveEdit(item.id);
                                                                        if (e.key === 'Escape') cancelEdit();
                                                                    }}
                                                                    autoFocus
                                                                />
                                                            ) : (
                                                                <span className={`flex-1 ${item.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                                    {item.text}
                                                                </span>
                                                            )}
                                                        </div>
                                                        
                                                        <div className="flex items-center gap-2">
                                                            {editingId === item.id ? (
                                                                <>
                                                                    <button
                                                                        onClick={() => saveEdit(item.id)}
                                                                        className="text-green-500 hover:text-green-700 p-1"
                                                                    >
                                                                        <Check size={16} />
                                                                    </button>
                                                                    <button
                                                                        onClick={cancelEdit}
                                                                        className="text-red-500 hover:text-red-700 p-1"
                                                                    >
                                                                        <X size={16} />
                                                                    </button>
                                                                </>
                                                            ) : (
                                                                <>
                                                                    <button
                                                                        onClick={() => startEditing(item.id, item.text)}
                                                                        className="text-blue-500 hover:text-blue-700 p-1"
                                                                    >
                                                                        <Edit3 size={16} />
                                                                    </button>
                                                                    <button
                                                                        onClick={() => deleteItem(item.id)}
                                                                        className="text-red-500 hover:text-red-700 p-1"
                                                                    >
                                                                        <Trash2 size={16} />
                                                                    </button>
                                                                </>
                                                            )}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {items.length === 0 && (
                            <div className="bg-white rounded-2xl shadow-lg p-12 text-center">
                                <div className="text-gray-400 mb-4">
                                    <Plus size={64} className="mx-auto" />
                                </div>
                                <h3 className="text-xl font-semibold text-gray-600 mb-2">הרשימה ריקה</h3>
                                <p className="text-gray-500">התחל להוסיף פריטים לרשימת הקניות שלך</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<GroceryApp />, document.getElementById('root'));
    </script>
</body>
</html>