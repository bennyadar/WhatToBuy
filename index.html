import React, { useState, useEffect } from 'react';
import { Plus, Share2, Copy, Trash2, ShoppingCart, Users, Download } from 'lucide-react';

const GroceryApp = () => {
  const [items, setItems] = useState([]);
  const [newItem, setNewItem] = useState('');
  const [bulkText, setBulkText] = useState('');
  const [activeTab, setActiveTab] = useState('add');
  const [sharedLists, setSharedLists] = useState([]);
  const [listName, setListName] = useState('רשימת הקניות שלי');
  const [showBulkInput, setShowBulkInput] = useState(false);

  // Hebrew grocery categories with common items
  const categories = {
    'פירות וירקות': [
      'עגבניות', 'מלפפונים', 'חסה', 'גזר', 'בצל', 'שום', 'פלפל', 'תפוחים', 'בננות',
      'תפוזים', 'לימון', 'אבוקדו', 'ברוקולי', 'כרובית', 'תרד', 'פטרוזיליה', 'כוסברה',
      'דיל', 'בזיליקום', 'תפוחי אדמה', 'בטטה', 'צנון', 'סלרי', 'אפונה', 'שעועית ירוקה'
    ],
    'חלב וביצים': [
      'חלב', 'ביצים', 'חמאה', 'גבינה צהובה', 'גבינה לבנה', 'יוגורט', 'שמנת חמוצה',
      'קוטג׳', 'לבנה', 'גבינת עיזים', 'מוצרלה', 'פטה', 'חלב שקדים', 'חלב קוקוס'
    ],
    'בשר ועוף': [
      'עוף שלם', 'חזה עוף', 'כרעיים עוף', 'בשר טחון', 'אנטריקוט', 'פרגיות', 'כבד עוף',
      'נקניק', 'נקניקיות', 'פסטרמה', 'סלמי', 'המבורגר', 'קבב', 'שניצל'
    ],
    'דגים': [
      'סלמון', 'דניס', 'אמנון', 'בקלה', 'טונה', 'סרדינים', 'הרינג', 'מקרל', 'קרפיון'
    ],
    'מוצרי קמח ולחם': [
      'לחם', 'פיתה', 'בגט', 'קמח', 'פסטה', 'אורז', 'בורגול', 'קוסקוס', 'כוסמין',
      'שיבולת שועל', 'לחם מחמצת', 'חלה', 'מצות', 'פקעות', 'לחמניות'
    ],
    'מוצרי יבש ושימורים': [
      'עדשים', 'חומוס יבש', 'שעועית', 'אפונה יבשה', 'אורז', 'פסטה', 'קמח', 'סוכר',
      'מלח', 'פלפל שחור', 'פפריקה', 'כמון', 'כוסברה טחונה', 'קינמון', 'צ׳ילי',
      'שמן זית', 'שמן קנולה', 'חומץ', 'דבש', 'ריבה', 'טחינה', 'חרדל'
    ],
    'קפואים': [
      'ירקות קפואים', 'שעועית ירוקה קפואה', 'תירס קפוא', 'אפונה קפואה', 'תותים קפואים',
      'גלידה', 'פיצה קפואה', 'שניצל קפוא', 'דגים קפואים'
    ],
    'שתייה': [
      'מים', 'מיץ תפוזים', 'מיץ ענבים', 'קפה', 'תה', 'משקה קל', 'בירה', 'יין',
      'מים מינרליים', 'מיץ לימון', 'חלב שקדים'
    ],
    'ניקיון ובית': [
      'נייר טואלט', 'מגבות נייר', 'סבון כביסה', 'מרכך כביסה', 'חומר ניקוי כללי',
      'נייר אלומיניום', 'ניילון נצמד', 'שקיות זבל', 'סבון כלים', 'ספוג'
    ],
    'אחר': []
  };

  // Function to categorize items automatically
  const categorizeItem = (itemName) => {
    const cleanName = itemName.trim().toLowerCase();
    
    for (const [category, categoryItems] of Object.entries(categories)) {
      if (categoryItems.some(catItem => 
        cleanName.includes(catItem.toLowerCase()) || 
        catItem.toLowerCase().includes(cleanName)
      )) {
        return category;
      }
    }
    return 'אחר';
  };

  // Add single item
  const addItem = () => {
    if (newItem.trim()) {
      const category = categorizeItem(newItem);
      const item = {
        id: Date.now(),
        name: newItem.trim(),
        category,
        completed: false,
        addedAt: new Date()
      };
      setItems([...items, item]);
      setNewItem('');
    }
  };

  // Add multiple items from bulk text
  const addBulkItems = () => {
    if (!bulkText.trim()) return;
    
    const lines = bulkText.split('\n').filter(line => line.trim());
    const newItems = lines.map(line => {
      const cleanLine = line.trim().replace(/^[-•*]\s*/, ''); // Remove bullet points
      return {
        id: Date.now() + Math.random(),
        name: cleanLine,
        category: categorizeItem(cleanLine),
        completed: false,
        addedAt: new Date()
      };
    });
    
    setItems([...items, ...newItems]);
    setBulkText('');
    setShowBulkInput(false);
  };

  // Toggle item completion
  const toggleItem = (id) => {
    setItems(items.map(item => 
      item.id === id ? { ...item, completed: !item.completed } : item
    ));
  };

  // Delete item
  const deleteItem = (id) => {
    setItems(items.filter(item => item.id !== id));
  };

  // Group items by category
  const groupedItems = items.reduce((acc, item) => {
    if (!acc[item.category]) {
      acc[item.category] = [];
    }
    acc[item.category].push(item);
    return acc;
  }, {});

  // Share list functionality
  const shareList = () => {
    const listData = {
      id: Date.now(),
      name: listName,
      items: items,
      sharedAt: new Date(),
      sharedBy: 'משתמש'
    };
    
    // Simulate sharing - in a real app this would sync with a backend
    setSharedLists([...sharedLists, listData]);
    
    // Copy sharing link to clipboard
    const shareText = `רשימת קניות: ${listName}\n\n${items.map(item => `• ${item.name}`).join('\n')}`;
    navigator.clipboard.writeText(shareText).then(() => {
      alert('הרשימה הועתקה ללוח! כעת תוכל לשתף אותה');
    });
  };

  // Load shared list
  const loadSharedList = (sharedList) => {
    setItems(sharedList.items);
    setListName(sharedList.name);
    setActiveTab('add');
  };

  // Export list
  const exportList = () => {
    const exportText = `רשימת קניות: ${listName}\nנוצרה ב: ${new Date().toLocaleDateString('he-IL')}\n\n${Object.entries(groupedItems).map(([category, categoryItems]) => 
      `${category}:\n${categoryItems.map(item => `  • ${item.name}${item.completed ? ' ✓' : ''}`).join('\n')}`
    ).join('\n\n')}`;
    
    const blob = new Blob([exportText], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${listName}.txt`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const stats = {
    total: items.length,
    completed: items.filter(item => item.completed).length,
    categories: Object.keys(groupedItems).length
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100" dir="rtl">
      <div className="container mx-auto px-4 py-6 max-w-4xl">
        {/* Header */}
        <div className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between flex-wrap gap-4">
            <div>
              <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                <ShoppingCart className="text-blue-600" />
                רשימת קניות חכמה
              </h1>
              <input
                type="text"
                value={listName}
                onChange={(e) => setListName(e.target.value)}
                className="mt-2 text-lg font-medium text-gray-600 bg-transparent border-b-2 border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none transition-colors"
                placeholder="שם הרשימה"
              />
            </div>
            <div className="flex gap-2">
              <button
                onClick={exportList}
                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"
              >
                <Download size={16} />
                ייצא
              </button>
              <button
                onClick={shareList}
                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
              >
                <Share2 size={16} />
                שתף
              </button>
            </div>
          </div>
          
          {/* Stats */}
          <div className="flex gap-4 mt-4 text-sm">
            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
              סה״כ: {stats.total}
            </span>
            <span className="bg-green-100 text-green-800 px-3 py-1 rounded-full">
              הושלמו: {stats.completed}
            </span>
            <span className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full">
              קטגוריות: {stats.categories}
            </span>
          </div>
        </div>

        {/* Navigation Tabs */}
        <div className="bg-white rounded-2xl shadow-lg mb-6">
          <div className="flex border-b border-gray-200">
            <button
              onClick={() => setActiveTab('add')}
              className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                activeTab === 'add' 
                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              הוספת מוצרים
            </button>
            <button
              onClick={() => setActiveTab('list')}
              className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                activeTab === 'list' 
                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              הרשימה שלי
            </button>
            <button
              onClick={() => setActiveTab('shared')}
              className={`flex-1 py-4 px-6 text-center font-medium transition-colors ${
                activeTab === 'shared' 
                  ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50' 
                  : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              רשימות משותפות
            </button>
          </div>

          {/* Tab Content */}
          <div className="p-6">
            {activeTab === 'add' && (
              <div className="space-y-6">
                {/* Single item input */}
                <div>
                  <h3 className="text-lg font-semibold mb-3">הוסף מוצר יחיד</h3>
                  <div className="flex gap-2">
                    <input
                      type="text"
                      value={newItem}
                      onChange={(e) => setNewItem(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && addItem()}
                      placeholder="הכנס שם מוצר..."
                      className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                    />
                    <button
                      onClick={addItem}
                      className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition-colors flex items-center gap-2"
                    >
                      <Plus size={20} />
                      הוסף
                    </button>
                  </div>
                </div>

                {/* Bulk input toggle */}
                <div className="border-t pt-6">
                  <button
                    onClick={() => setShowBulkInput(!showBulkInput)}
                    className="text-blue-600 hover:text-blue-700 font-medium flex items-center gap-2"
                  >
                    <Copy size={16} />
                    {showBulkInput ? 'סגור הדבקה מרובת שורות' : 'הדבק רשימה מאפליקציה אחרת'}
                  </button>
                  
                  {showBulkInput && (
                    <div className="mt-4">
                      <h3 className="text-lg font-semibold mb-3">הדבק רשימה מווצאפ או אפליקציה אחרת</h3>
                      <textarea
                        value={bulkText}
                        onChange={(e) => setBulkText(e.target.value)}
                        placeholder="הדבק כאן את הרשימה שלך... כל מוצר בשורה נפרדת"
                        className="w-full h-32 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none"
                      />
                      <div className="flex gap-2 mt-3">
                        <button
                          onClick={addBulkItems}
                          className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors"
                        >
                          הוסף הכל
                        </button>
                        <button
                          onClick={() => setBulkText('')}
                          className="bg-gray-400 hover:bg-gray-500 text-white px-6 py-2 rounded-lg transition-colors"
                        >
                          נקה
                        </button>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}

            {activeTab === 'list' && (
              <div>
                {Object.keys(groupedItems).length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <ShoppingCart size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>הרשימה שלך ריקה</p>
                    <p className="text-sm">התחל בהוספת מוצרים בכרטיסייה "הוספת מוצרים"</p>
                  </div>
                ) : (
                  <div className="space-y-6">
                    {Object.entries(groupedItems).map(([category, categoryItems]) => (
                      <div key={category} className="bg-gray-50 rounded-xl p-4">
                        <h3 className="text-lg font-bold text-gray-800 mb-3 flex items-center">
                          {category}
                          <span className="mr-2 bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                            {categoryItems.length}
                          </span>
                        </h3>
                        <div className="grid gap-2">
                          {categoryItems.map(item => (
                            <div
                              key={item.id}
                              className={`flex items-center justify-between p-3 bg-white rounded-lg shadow-sm border-r-4 transition-all ${
                                item.completed 
                                  ? 'border-green-400 bg-green-50 opacity-75' 
                                  : 'border-blue-400 hover:shadow-md'
                              }`}
                            >
                              <div className="flex items-center gap-3">
                                <input
                                  type="checkbox"
                                  checked={item.completed}
                                  onChange={() => toggleItem(item.id)}
                                  className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                />
                                <span className={`font-medium ${
                                  item.completed ? 'text-gray-500 line-through' : 'text-gray-800'
                                }`}>
                                  {item.name}
                                </span>
                              </div>
                              <button
                                onClick={() => deleteItem(item.id)}
                                className="text-red-500 hover:text-red-700 p-1 rounded transition-colors"
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {activeTab === 'shared' && (
              <div>
                {sharedLists.length === 0 ? (
                  <div className="text-center py-12 text-gray-500">
                    <Users size={48} className="mx-auto mb-4 text-gray-300" />
                    <p>אין רשימות משותפות</p>
                    <p className="text-sm">שתף רשימה כדי שתופיע כאן</p>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {sharedLists.map(sharedList => (
                      <div key={sharedList.id} className="bg-white border border-gray-200 rounded-xl p-4">
                        <div className="flex justify-between items-start">
                          <div>
                            <h3 className="font-bold text-lg text-gray-800">{sharedList.name}</h3>
                            <p className="text-sm text-gray-500">
                              שותף על ידי {sharedList.sharedBy} • {sharedList.items.length} מוצרים
                            </p>
                            <p className="text-xs text-gray-400">
                              {new Date(sharedList.sharedAt).toLocaleDateString('he-IL')}
                            </p>
                          </div>
                          <button
                            onClick={() => loadSharedList(sharedList)}
                            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"
                          >
                            טען רשימה
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default GroceryApp;
